# WireGuard VPN Setup Documentation

## Overview

This is mainly for future purposes where I will inevitably forget what was done and how to resolve
issues. We use the `bryopsida/wireguard-chart` Helm chart deployed via ArgoCD.

## Network Architecture

### Subnets

- **Homelab LAN:** `192.168.50.0/24`
- **WireGuard VPN:** `10.50.0.0/24`
  - Server: `10.50.0.1/24`
  - Client IPs: `10.50.0.2` - `10.50.0.254`

### Services

- **MetalLB LoadBalancer IP:** `192.168.50.51`
- **PiHole DNS:** `192.168.50.50`
- **Ingress Controller:** `192.168.50.2` (nginx-internal)
- **Public IP:** `119.18.7.121` (as of Dec 2025)

### Routing Configuration

- **Split-tunnel VPN:** Only routes homelab traffic (`192.168.50.0/24` + `10.50.0.0/24`) through VPN
- **Internet traffic:** Uses client's default route (direct)

## Configuration Reference

### Helm Values (`wireguard.values.yaml`)

**Key settings:**

```yaml
wireguard:
  serverAddress: "10.50.0.1/24"
  serverCidr: "10.50.0.0/24"

  interfaceOpts:
    DNS: "192.168.50.50" # The PiHole DNS server address
    PostUp: "iptables -t nat -A POSTROUTING -s 10.50.0.0/24 -o eth0 -j MASQUERADE; iptables -A FORWARD -i wg0 -s 10.50.0.0/24 -d 192.168.50.0/24 -j ACCEPT; iptables -A FORWARD -i eth0 -s 192.168.50.0/24 -d 10.50.0.0/24 -j ACCEPT"
    PostDown: "iptables -t nat -D POSTROUTING -s 10.50.0.0/24 -o eth0 -j MASQUERADE; iptables -D FORWARD -i wg0 -s 10.50.0.0/24 -d 192.168.50.0/24 -j ACCEPT; iptables -D FORWARD -i eth0 -s 192.168.50.0/24 -d 10.50.0.0/24 -j ACCEPT"

  clients:
    - PublicKey: "<CLIENT_PUBLIC_KEY>"
      AllowedIPs: "10.50.0.2/32"
      FriendlyName: "catchall"
      PersistentKeepalive: 25

service:
  type: LoadBalancer
  port: 51820
  loadBalancerIP: "192.168.50.51"
```

### Client Configuration Template

```ini
[Interface]
PrivateKey = <CLIENT_PRIVATE_KEY>
Address = 10.50.0.2/32
DNS = 192.168.50.50

[Peer]
PublicKey = <SERVER_PUBLIC_KEY>  # Get from logs after deployment
Endpoint = <YOUR_PUBLIC_IP>:51820
AllowedIPs = 192.168.50.0/24, 10.50.0.0/24
PersistentKeepalive = 25
```

## Installation

1. Define the ArgoCD application yaml: `/home/anthonyd/Documents/personal/homelab/apps/networking/wireguard.yaml`
2. Define the Helm values: `/home/anthonyd/Documents/personal/homelab/apps/networking/values/wireguard.values.yaml`
3. Update kustomization.yaml to include wireguard resource: `/home/anthonyd/Documents/personal/homelab/apps/networking/kustomization.yaml`
4. Generate client configurations by using `wireguard-tools` to generate client keys.

### Using wireguard-tools to generate client keys

```bash
sudo apt install wireguard-tools

# Generate client keys
wg genkey | tee /tmp/client_private.key | wg pubkey > /tmp/client_public.key

# NOTE: The server key is autogenerated on deployment by the helm chart.
```

### Test Locally (Optional)

This is to test the `values.yaml` before committing to git.

```bash
# Add Helm repo
helm repo add bryopsida https://bryopsida.github.io/wireguard-chart
helm repo update

# Dry-run to validate
helm install wireguard bryopsida/wireguard \
  --version 0.31.0 \
  --namespace wireguard-system \
  --create-namespace \
  --values apps/networking/values/wireguard.values.yaml \
  --dry-run --debug
```

### 5. Deploy via ArgoCD

Commit values file to git and deploy via CLI: `k apply -f wireguard.yaml`

### 6. Monitor Deployment

```bash
# Watch ArgoCD sync either via CLI or through web interface. If we use the web interface, we can
# ignore the below steps.
kubectl get applications -n argocd wireguard -w

# Check pod status
kubectl get pods -n wireguard-system

# Verify service has LoadBalancer IP
kubectl get svc -n wireguard-system

# Check logs
kubectl logs -n wireguard-system -l app=wireguard-wireguard -c wireguard
```

### 6. Get Server Public Key

```bash
# From logs
kubectl logs -n wireguard-system -l app=wireguard-wireguard -c wireguard | grep "Public key"

# Output: Public key 'x36bsLac1aRdd8MkMZ1zPo1kfH4QGN1F3zkN8T3T+BI='
```

### 7. Create Client Configuration

Create `client-wg0.conf` with:

- Client private key from step 1
- Server public key from step 6
- Your public IP address

### 8. Generate QR Code for Mobile Devices

```bash
# Install qrencode
sudo apt install qrencode

# Generate QR code in terminal
qrencode -t ansiutf8 < client-wg0.conf

# Or save as PNG
qrencode -t png -o client-wg0-qr.png < client-wg0.conf
```

### 9. Configure Router Port Forwarding

- Protocol: **UDP**
- External Port: **51820**
- Internal IP: **192.168.50.51**
- Internal Port: **51820**

### 10. Configure PiHole

1. Access PiHole: `http://pihole.home/admin`
2. Navigate to: **Settings → DNS → Interface Settings**
3. Select: **"Permit all origins"** (or add `10.50.0.0/24` to allowed subnets)
4. Click **"Save"**

This allows PiHole to respond to DNS queries from VPN clients.

### 11. Test VPN Connection

**On client device (phone/laptop):**

1. Import `client-wg0.conf` or scan QR code in WireGuard app
2. Activate VPN connection
3. Verify connection:
   - WireGuard shows "Active" status
   - "Latest handshake" updates every ~25 seconds
   - Data transfer counters increase

4. Test connectivity:

   ```bash
   ping 10.50.0.1           # WireGuard server
   ping 192.168.50.50       # PiHole
   ping 192.168.50.2        # Ingress controller
   ```

5. Test DNS resolution:

   ```bash
   nslookup jellyfin.sheeplet.com 192.168.50.50
   ```

6. Access services via browser:
   - `http://jellyfin.sheeplet.com`
   - `http://homepage.sheeplet.com`
   - `http://pihole.home/admin`

## Issues Encountered & Solutions

### Client Cannot Connect/Access Services

**Symptoms:**

- VPN appears connected but client cannot access homelab services.
- No data transfer shown in WireGuard app
- Services don't load in browser

**Cause:** Client configuration had wrong server public key (used pre-generated key instead of auto-generated server key).

**Solution:**

1. Retrieved actual server public key from logs:

   ```bash
   kubectl logs -n wireguard-system -l app=wireguard-wireguard -c wireguard | grep "Public key"
   ```

2. Updated client configuration `[Peer]` section with correct `PublicKey`

3. Generated a new QR code with corrected config.

## Adding New Clients

### Method 1: Same Configuration (Multiple Devices)

If using the same client configuration on multiple devices (like the catchall config):

1. Simply distribute the same `client-wg0.conf` or QR code
2. All devices will share IP `10.50.0.2`
3. **Note:** This is convenient but less secure and harder to troubleshoot

### Method 2: Unique Configuration Per Device

For better security and troubleshooting:

1. **Generate new client keys:**

   ```bash
   wg genkey | tee client2_private.key | wg pubkey > client2_public.key
   ```

2. **Update `wireguard.values.yaml`:**

   ```yaml
   clients:
     - PublicKey: "<CLIENT_PUBLIC_KEY>"
       AllowedIPs: "10.50.0.2/32"
       FriendlyName: "catchall"
       PersistentKeepalive: 25
     - PublicKey: "<NEW_CLIENT_PUBLIC_KEY>"
       AllowedIPs: "10.50.0.3/32"
       FriendlyName: "phone"
       PersistentKeepalive: 25
   ```

3. **Commit and push:**

   ```bash
   git add apps/networking/values/wireguard.values.yaml
   git commit -m "feat(wireguard): add new client device"
   git push origin main
   ```

   ArgoCD will auto-sync and add the client.

4. **Create client config:**

   ```ini
   [Interface]
   PrivateKey = <NEW_CLIENT_PRIVATE_KEY>
   Address = 10.50.0.3/32
   DNS = 192.168.50.50

   [Peer]
   PublicKey = <SERVER_PUBLIC_KEY>
   Endpoint = 119.18.7.121:51820
   AllowedIPs = 192.168.50.0/24, 10.50.0.0/24
   PersistentKeepalive = 25
   ```

5. **Generate QR code:**
   ```bash
   qrencode -t ansiutf8 < client2-wg0.conf
   ```

## Removing Clients

1. Remove client entry from `wireguard.values.yaml`
2. Commit and push
3. ArgoCD will auto-sync and remove client access
4. No server restart needed

## Troubleshooting

### Check VPN Server Status

```bash
# Pod status
kubectl get pods -n wireguard-system

# Service and LoadBalancer IP
kubectl get svc -n wireguard-system

# ArgoCD sync status
kubectl get application -n argocd wireguard

# Logs
kubectl logs -n wireguard-system -l app=wireguard-wireguard -c wireguard --tail=50
```

### Check Network Connectivity

```bash
# From VPN client
ping 10.50.0.1           # WireGuard server
ping 192.168.50.50       # PiHole
ping 192.168.50.2        # Ingress controller

# DNS test
nslookup jellyfin.sheeplet.com 192.168.50.50

# Direct IP access
curl http://192.168.50.2
```

### Common Issues

**Can't connect to VPN:**

- Verify router port forwarding is setup.
- Check that LoadBalancer IP has been assigned: `kubctl get svc -n wireguard-system`
- Verify that the public IP in the client config matches the actual public IP.
- Verify that the client has the correct server public key.

**VPN is connected but we cannot access services:**

- Confirm that `AllowedIPs = 192.168.50.0/24, 10.50.0.0/24` is in the client config.
- Verify PiHole VPN subnet settings
- Check that iptables rules are applied using pod logs for PostUp execution.

**DNS not working:**

- Verify `DNS = 192.168.50.50` in client config
- Check PiHole is running: `kubectl get pods -n pihole-system`
- Test direct ping to PiHole: `ping 192.168.50.50`
